import os
import telebot
import random
import re
from telebot import types

TOKEN = os.getenv("TOKEN")
if not TOKEN:
    raise RuntimeError("TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è")

bot = telebot.TeleBot(TOKEN)

# ===== –ó–ê–ì–†–£–ó–ö–ê –°–õ–û–í–ê–†–Ø –ò–ó –ù–ï–°–ö–û–õ–¨–ö–ò–• –§–ê–ô–õ–û–í =====

DAL_FILES = ['dal_1.txt', 'dal_2.txt']


def load_dal_words(files):
    all_words = []

    for filename in files:
        if not os.path.exists(filename):
            print(f'–û–®–ò–ë–ö–ê: —Ñ–∞–π–ª {filename} –Ω–µ –Ω–∞–π–¥–µ–Ω')
            continue

        with open(filename, 'r', encoding='utf-8') as f:
            text = f.read()

        blocks = re.split(r'\n\s*\n', text)
        words = [block.strip() for block in blocks if block.strip()]
        all_words.extend(words)

    if not all_words:
        raise RuntimeError("–°–ª–æ–≤–∞—Ä–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—É—Å—Ç—ã –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")

    print(f'–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–ª–æ–≤: {len(all_words)}')
    return all_words


WORDS = load_dal_words(DAL_FILES)


def get_random_dal_word():
    return random.choice(WORDS)

# ===== –ö–õ–ê–í–ò–ê–¢–£–†–ê =====


def main_keyboard():
    keyboard = types.ReplyKeyboardMarkup(
        resize_keyboard=True,
        one_time_keyboard=False
    )
    keyboard.add(types.KeyboardButton('–°–ª–æ–≤–µ—Å–æ'))
    return keyboard

# ===== –•–ï–ù–î–õ–ï–†–´ =====


@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(
        message.chat.id,
        "–ù–æ–≤—ã–µ —Å–ª–æ–≤–µ—Å–∞, —Å—É—à–∫–∏, –±–µ—Å–ø—Ä–µ–¥–µ–ª.",
        reply_markup=main_keyboard()
    )


@bot.message_handler(func=lambda message: message.text == '–°–ª–æ–≤–µ—Å–æ')
def send_word(message):
    bot.send_message(
        message.chat.id,
        "–ë–µ—Ä–∏, –¥—Ä—É–≥ —Å–µ—Ä–¥–µ—á–Ω—ã–π ü™∂"
    )

    bot.send_message(
        message.chat.id,
        get_random_dal_word(),
        reply_markup=main_keyboard()
    )

# ===== –ó–ê–ü–£–°–ö =====

bot.infinity_polling(skip_pending=True)

